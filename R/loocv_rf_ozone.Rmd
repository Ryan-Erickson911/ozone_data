---
title: "Ozone Prediction via Random forrest: Leave One Out Cross Validation"
author: "Ryan Erickson"
date: "2023-07-18"
output: pdf_document
---

# Libraries

```{r, warning=FALSE, message = FALSE}
library(dplyr)
library(tidyr)
library(caret)
```

# Data

-   Load in Data
-   Split Dates into Month and Year
-   Group by months
-   Sort by year, then month
-   Make into Data Frame
-   Factor site name and dates

```{r}
ozone_data=read.csv("../final_data/ozone_data.csv") %>% 
  dplyr::select(site_name,date,lat,long,mda8,everything())

ozone_data = ozone_data %>%
  separate(date, c("Months","Years"),remove =F) %>% 
  mutate(Months=match(Months,month.abb)) %>% 
  group_by(Months) %>% 
  arrange(Years, Months)  %>% 
  ungroup() %>% 
  dplyr::select(mda8,everything()) %>% 
  dplyr::select(-"X") %>% 
  as.data.frame()

#rf_model_dates.mda8=as.data.frame(ozone_data[,c(-14:-26)])
ozone_data$Months=as.factor(ozone_data$Months)
ozone_data$Years=as.factor(ozone_data$Years)
ozone_data$date = as.factor(ozone_data$date)
ozone_data$site_name = as.factor(ozone_data$site_name)

# No dates or Site name
# rf_model_nd.mda8=as.data.frame(ozone_data[,c(-2:-7,-15:-27)])
```

```{r, include=FALSE}
## Line for Sgnificance
line1 = glm(mda8~., data=ozone_data[,-2:-5])
summary(line1)
```

```{r, include=FALSE}
### Basic LOOCV

# #specify LOOCV
# control <- trainControl(method = "LOOCV")
# 
# #fit a rf model and use LOOCV to evaluate performance
# model <- train(mda8 ~ ., data = rf_model_nd.mda8, method = "rf", trControl = control)
# model
```

```{r, include=FALSE}
### Basic LOOCV - With dates
# #fit a rf model and use LOOCV to evaluate performance
# model_dates <- train(mda8 ~ ., data = ozone_data, method = "rf", trControl = control)
# model_dates
```

# Fine Tuned Random Forest Results

## Creating Folds -> Plotting Results

### PROBLEMS:

-   There is a known issue in caret v 6.0-86 that has still not been updated. k = 8 in groupKFold() results in 7 folds, with 2 monitors being left out in 2 different folds. The other 4 folds have one monitor left out correctly

- Solution: Created function to properly l.o.o 

```{r}
create_kfolds <- function(x, k = length(unique(x))) {
  dat <- data.frame(index = seq(along = x), group = x)
  groups <- data.frame(group = unique(dat$group))
  group_folds <- createFolds(groups$group, returnTrain = TRUE, k = k)
  group_folds <- lapply(group_folds, function(x, y) y[x,,drop = FALSE], y = groups)
  dat_folds <- lapply(group_folds, function(x, y) merge(x, y), y = dat)
  lapply(dat_folds, function(x) sort(x$index))
}
```

- groupKFold() example and result

```{r, echo=FALSE, message=FALSE,warning=FALSE, fig.width=9}
set.seed(197)
kfolds <- groupKFold(ozone_data$site_name, k=16) 

in_model <- lapply(kfolds, function(ind, grp) grp[ind], grp = ozone_data$site_name)
in_model_df <- data.frame(Subject = unlist(in_model), data = "Used for Modeling")
in_model_df$Fold <- rep(names(in_model), times = unlist(lapply(in_model, length)))
holdout <- lapply(kfolds, function(ind, grp) grp[-unique(ind)], grp = ozone_data$site_name)
holdout_df <- data.frame(Subject = unlist(holdout), data = "Withheld")
holdout_df$Fold <- rep(names(holdout), times = unlist(lapply(holdout, length)))
both <- rbind(in_model_df, holdout_df)
ggplot(both, aes(x = Fold, y = Subject, fill = data)) + 
  geom_tile(color="black") + 
  ggthemes::scale_fill_tableau() + 
  theme_bw()
```

- New Function example and result

```{r, echo=FALSE, message=FALSE,warning=FALSE, fig.width=9}
set.seed(197)
# kfolds <- groupKFold(ozone_data$site_name, k=8, replace = FALSE) 
kfolds = create_kfolds(ozone_data$site_name)

in_model <- lapply(kfolds, function(ind, grp) grp[ind], grp = ozone_data$site_name)
in_model_df <- data.frame(Subject = unlist(in_model), data = "Used for Modeling")
in_model_df$Fold <- rep(names(in_model), times = unlist(lapply(in_model, length)))
holdout <- lapply(kfolds, function(ind, grp) grp[-unique(ind)], grp = ozone_data$site_name)
holdout_df <- data.frame(Subject = unlist(holdout), data = "Withheld")
holdout_df$Fold <- rep(names(holdout), times = unlist(lapply(holdout, length)))
both <- rbind(in_model_df, holdout_df)
ggplot(both, aes(x = Fold, y = Subject, fill = data)) + 
  geom_tile(color="black") + 
  ggthemes::scale_fill_tableau() + 
  theme_bw()
```

## Base Model:
- No site name

```{r}
# Creating Seeds
set.seed(197)
seeds <- vector(mode = "list", length = 17) # length is (n_repeats*nresampling) + 1: n_repeats=6 * nresampling=1 +1 = 7 
for(i in 1:16) seeds[[i]]<- sample.int(n=1000, 3) # the number of tuning parameters
seeds[[17]]<-sample.int(1000, 1) # for the last model

# Training Model
def_control <- trainControl(
  method = 'LOOCV',
  number = 16,# should be number of folds/re sampling iterations, from groupKFold() -> length(unique(ozone_data$site_name)) = 16
  index = kfolds,                 # a list with elements for each re sampling iteration, created with groupKFold
  p = 1,                          # for leave one group out cross validation: the training percentage (want to leave entire group out)   
  savePredictions = 'final',      # saves predictions for optimal tuning parameter
  seed = seeds      # setting seed for repetition of results, I can't get this to work, stack over flow says it's needed?
)

model_tuned = train(mda8~.,data=ozone_data[,c(-2)],method='rf',trControl=def_control)
```

### Results

```{r}
ozone_data[model_tuned$pred$rowIndex,]
model_tuned
#### Variable Importance
varImp(model_tuned, scale=FALSE)
```

## Tuned Model-1:
- No site name
- No NDVI

```{r}
# Creating Seeds
set.seed(197)
seeds <- vector(mode = "list", length = 17) # length is (n_repeats*nresampling) + 1: n_repeats=6 * nresampling=1 +1 = 7 
for(i in 1:16) seeds[[i]]<- sample.int(n=1000, 3) # the number of tuning parameters
seeds[[17]]<-sample.int(1000, 1) # for the last model

# Training Model
def_control <- trainControl(method = 'LOOCV',number = 16,index = kfolds,p = 1,savePredictions = 'final',seed = seeds)
model_tuned = train(mda8~.,data=ozone_data[,c(-2,-8)],method='rf',trControl=def_control)
# outputs
ozone_data[model_tuned$pred$rowIndex,]
model_tuned
#### Variable Importance
varImp(model_tuned, scale=FALSE)
```

## Tuned Model-2:
- No site name
- No Dummies (full date incl.)

```{r}
# Creating Seeds
set.seed(197)
seeds <- vector(mode = "list", length = 17) # length is (n_repeats*nresampling) + 1: n_repeats=6 * nresampling=1 +1 = 7 
for(i in 1:16) seeds[[i]]<- sample.int(n=1000, 3) # the number of tuning parameters
seeds[[17]]<-sample.int(1000, 1) # for the last model

# Training Model
def_control <- trainControl(method = 'LOOCV',number = 16,index = kfolds,p = 1,savePredictions = 'final',seed = seeds)
model_tuned = train(mda8~.,data=ozone_data[,c(-2,-4:-5)],method='rf',trControl=def_control)
# outputs
ozone_data[model_tuned$pred$rowIndex,]

#### Variable Importance
varImp(model_tuned, scale=FALSE)
# caret::predict.train(model_tuned, newdata=grd)
```
