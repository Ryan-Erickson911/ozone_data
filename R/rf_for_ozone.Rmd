---
title: "Ozone_Random_Forest"
author: "Ryan Erickson"
date: "2023-06-05"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE, eval = TRUE, warning = FALSE)
```

# Libraries

```{r, warning=FALSE, message = FALSE}
library(dplyr)
library(tidyr)
library(MASS)
library(rpart)
library(ranger)
library(pROC)
library(Metrics)
library(RColorBrewer)
```

# Data

 - Comes from data_processing.R, should run before hand for consistency 
 - pmax is monthly sum of daily max precipitation values

```{r}
ozone_data=read.csv("../final_data/ozone_data.csv")%>% 
  dplyr::select(site_name,date,lat,long,mda8,everything())

# ozone_data %>%
#   separate(date, c("Months","Years"),remove =F) %>% 
#   mutate(Months=match(Months,month.abb)) %>% 
#   group_by(Months) %>% 
#   arrange(Years, Months)  %>% 
#   ungroup() %>% 
#   dplyr::select(mda8,everything()) %>% 
#   dplyr::select(-c("Months","Years","X")) %>%
#   write.csv("../final_data/ozone_data_sorted.csv")

ozone_data$site_name = as.factor(ozone_data$site_name)
ozone_data$date = as.factor(ozone_data$date)  

ozone_data_no.mda8_names = ozone_data %>%
  separate(date, c("Months","Years"),remove =F) %>% 
  mutate(Months=match(Months,month.abb)) %>% 
  group_by(Months) %>% 
  arrange(Years, Months)  %>% 
  ungroup() %>% 
  dplyr::select(-c("mda8","site_name","date","Months","Years","X")) %>% 
  as.data.frame()

ozone_data_mda8_first.no_name = ozone_data %>%
  separate(date, c("Months","Years"),remove =F) %>% 
  mutate(Months=match(Months,month.abb)) %>% 
  group_by(Months) %>% 
  arrange(Years, Months)  %>% 
  ungroup() %>% 
  dplyr::select(mda8,everything()) %>% 
  dplyr::select(-c("site_name","date","Months","Years","X")) %>% 
  as.data.frame()

ozone_data %>%
  separate(date, c("Months","Years"),remove =F) %>% 
  mutate(Months=match(Months,month.abb)) %>% 
  group_by(Months) %>% 
  arrange(Years, Months)  %>% 
  ungroup() %>% 
  dplyr::select(mda8,everything()) %>% 
  dplyr::select(-c("Months","Years","X")) %>%
  write.csv("../final_data/ozone_data_sorted.csv")

head(ozone_data_no.mda8_names)
head(ozone_data_mda8_first.no_name)
```

### Summary of LM models with Dummy Variables Included

```{r}
line1 = glm(mda8~., data=ozone_data_mda8_first.no_name)
summary(line1)
```

### Summary of LM models with no Dummy Variables

```{r}
line_nd=ozone_data_mda8_first.no_name[,c(-2,-3,-11:-22)]
line_nd = glm(mda8~., data=line_nd)
summary(line_nd)
```

### Checking Linearity for all Variables

```{r, fig.height=4.2}
n = 21
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector = unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))
col=sample(col_vector, n)

for (i in 1:ncol(ozone_data_no.mda8_names)) { 
 plot(x=ozone_data_no.mda8_names[,i],
       y=ozone_data_mda8_first.no_name$mda8,
       main = paste0('Figure ',i,': MDA8 vs. ',colnames(ozone_data_no.mda8_names)[i]),
       xlab = paste0(colnames(ozone_data_no.mda8_names)[i]),
       ylab = "MDA8 Value",
       pch = 19)
  abline(lm(reformulate(paste0(names(ozone_data_no.mda8_names[i])),"mda8"),ozone_data_mda8_first.no_name),
         col = col[i],
         lwd = 2)
}
```

### Checking Linearity for variables, exluding dummy variables

```{r}
rf_model_nd.mda8=as.data.frame(ozone_data_mda8_first.no_name[,c(-2,-3,-11:-22)])
rf_model_nd=as.data.frame(ozone_data_mda8_first.no_name[,c(-1,-2,-3,-11:-22)])

n = 7
qual_col_pals = brewer.pal.info[brewer.pal.info$category == 'qual',]
col_vector = unlist(mapply(brewer.pal, qual_col_pals$maxcolors, rownames(qual_col_pals)))
col=sample(col_vector, n)

for (i in 1:ncol(rf_model_nd)) { 
 plot(x=rf_model_nd[,i],
       y=rf_model_nd.mda8$mda8,
       main = paste0('Figure ',i,': MDA8 vs. ',colnames(rf_model_nd)[i]),
       xlab = paste0(colnames(rf_model_nd)[i]),
       ylab = "MDA8 Value",
       pch = 19)
  abline(lm(reformulate(paste0(names(rf_model_nd[i])),"mda8"),rf_model_nd.mda8),
         col = col[i],
         lwd = 2)
}
```

### Splitting the Data - Testing Linear Models: 75% train/test split

```{r}
sample_size = floor(0.75 * nrow(ozone_data_mda8_first.no_name))
set.seed(09111997)
splitting_data = sample(seq_len(nrow(ozone_data_mda8_first.no_name)), size = sample_size, replace=FALSE)

ozone_train_wd = ozone_data_mda8_first.no_name[splitting_data, ]
ozone_test_wd = ozone_data_mda8_first.no_name[-splitting_data, ]

lm.final_wd = glm(mda8~., data = ozone_train_wd)
###predicting on training date with test data
pred.vals = predict(object=lm.final_wd,new_data=ozone_test_wd,type = "response")
summary(lm.final_wd)
```

Linear Model RMSE = `r round(rmse(ozone_train_wd$mda8, pred.vals), digits=2)`

### Splitting the Data Without Dummy Variables - Testing Linear Models: 75% train/test split

```{r}
sample_size2 = floor(0.75 * nrow(rf_model_nd.mda8))
set.seed(09111997)
split_data = sample(seq_len(nrow(rf_model_nd.mda8)), size = sample_size2, replace=FALSE)

ozone_train = rf_model_nd.mda8[split_data, ]
ozone_test = rf_model_nd.mda8[-split_data, ]

lm.final = glm(mda8~., data = ozone_train)
pred.vals2 = predict(lm.final, new_data=ozone_test)
summary(lm.final)
```

Linear Model RMSE = `r round(rmse(ozone_train$mda8, pred.vals2), digits=2)`

### Fitting a Regression Tree - No Dummy Variables since RMSE was a little better without them

 - predict by month!!!

```{r, warning=FALSE, message = FALSE}
fit.tree = rpart(mda8~.,data=ozone_train)
#summary(fit.tree)
par(xpd = NA)
plot(fit.tree)
text(fit.tree)

pred.tree = predict(fit.tree,newdata=ozone_test)
```

Regression Tree RMSE = `r round(rmse(ozone_test$mda8, as.numeric(pred.tree)), digits=2)`


### Bagged tree for Comparison

```{r}
pred.boot = ranger(mda8~.,data=ozone_train,mtry=dim(ozone_train)[2]-1,num.trees=500)
pred.bag = predict(pred.boot,data=ozone_test)$predictions

imp_feats = ranger(mda8~.,data=ozone_train,probability=TRUE,importance="impurity_corrected", mtry=dim(ozone_train)[2]-1,num.trees=500)

cbind(sort(importance(imp_feats)))
```

Bagging RMSE = `r round(rmse(ozone_test$mda8, pred.bag), digits=2)`


### Random Forest

```{r}

fit.rf = ranger(mda8~.,data=ozone_train, num.trees = 500)
pred.rf = predict(fit.rf,data=ozone_test)
pred.rf = pred.rf$predictions

imp_feats2 = ranger(mda8~.,data=ozone_train,probability=TRUE,importance="impurity_corrected", num.trees = 500)
cbind(sort(importance(imp_feats2)))
```

RMSE = `r round(rmse(ozone_test$mda8,pred.rf), digits=2)`

### LOOCV

```{r}
library(caret)

#specify the cross-validation method
ctrl <- trainControl(method = "LOOCV")

#fit a regression model and use LOOCV to evaluate performance
model <- train(mda8 ~ ., data = rf_model_nd.mda8, method = "rf", trControl = ctrl)
model$results
model$pred
```

